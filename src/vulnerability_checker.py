from datetime import datetime, timedelta, timezone
import gspread
import pprint
from oauth2client.service_account import ServiceAccountCredentials
import os

from repository.jvn.vulnerabilities import Vulnerabilities
from mailer import Mailer

class VulnerabilityChecker:

  alert_score = 7.0
  mail_from = os.environ['SMTP_ACCOUNT']
  mail_to_string = ''

  def __init__(self):
    self.mailer = Mailer()
    self.mail_to_string = ','.join(self.get_mail_to_list())
    t_delta = timedelta(hours=9)
    JST = timezone(t_delta, 'JST')
    self.now = datetime.now(JST)
    self.target_date = self.now - timedelta(1)

  def run(self):
    vulnerabilities_repo = Vulnerabilities()
    vulnerabilities = []
    vulnerabilities.extend(vulnerabilities_repo.critical(self.target_date))
    vulnerabilities.extend(vulnerabilities_repo.important(self.target_date))

    if len(vulnerabilities) > 0:

      self.mailer.send(
        mail_to = self.mail_to_string,
        mail_from = self.mail_from,
        subject = "脆弱性チェッカー {} ({}件)".format(self.now.strftime('%Y/%m/%d'), len(vulnerabilities)),
        message = self.mail_message(vulnerabilities),
      )

  def get_mail_to_list(self):
    # use creds to create a client to interact with the Google Drive API
    scope =['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
    creds = ServiceAccountCredentials.from_json_keyfile_name('../client_secret.json', scope)
    client = gspread.authorize(creds)

    # Find a workbook by name and open the first sheet
    # Make sure you use the right name here.
    sheet = client.open("脆弱性チェッカー").sheet1

    # Extract and print all of the values
    list_of_mails = sheet.col_values(1)

    return list_of_mails

  def mail_message(self, vulnerabilities):
    msg = '緊急性の高い脆弱性に関する更新がありました。\r\n\r\n'
    for vuln in vulnerabilities:
      msg += """[脆弱性ID]
{}
[脆弱性タイトル]
{}
[詳細URL]
{}
[概要]
{}

""".format(vuln['id'], vuln['title'], vuln['link'], vuln['description'])
    return msg